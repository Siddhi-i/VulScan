{% extends "base.html" %}
{% block content %}

<section class="card card-main">
    <div class="card-header card-header-row">
        <div>
            <h2>Scan #{{ scan["id"] }}</h2>
            <p class="card-subtitle">
                Target: <span class="mono">{{ scan["target_url"] }}</span>
            </p>
            <p class="card-meta">
                Status:
                {% if scan["status"] == "completed" %}
                    <span class="badge badge-success">Completed</span>
                {% elif scan["status"] == "running" %}
                    <span class="badge badge-warning">Running</span>
                {% else %}
                    <span class="badge badge-error">Error</span>
                {% endif %}
                · Started: {{ scan["started_at"] or "-" }}
                · Finished: {{ scan["finished_at"] or "-" }}
            </p>
        </div>

        <div class="card-actions">
            <button
                type="button"
                class="btn btn-outline"
                onclick="window.history.back()"
            >
                ← Back
            </button>
            <button
                type="button"
                class="btn btn-primary"
                onclick="window.location.href='{{ url_for('download_csv', scan_id=scan['id']) }}'"
            >
                ⬇ Download Report (CSV)
            </button>
        </div>
    </div>

    <h3 class="section-title">Findings</h3>

    {% if findings %}
    <div class="table-wrapper">
        <table class="table">
            <thead>
            <tr>
                <th>Type</th>
                <th>Severity</th>
                <th>URL</th>
                <th>Parameter</th>
                <th>Payload</th>
                <th>Evidence</th>
            </tr>
            </thead>
            <tbody>
            {% for f in findings %}
                <tr>
                    <td>{{ f["vuln_type"] }}</td>
                    <td>
                        {% if f["severity"] == "Critical" %}
                            <span class="badge badge-critical">{{ f["severity"] }}</span>
                        {% elif f["severity"] == "High" %}
                            <span class="badge badge-error">{{ f["severity"] }}</span>
                        {% elif f["severity"] == "Medium" %}
                            <span class="badge badge-warning">{{ f["severity"] }}</span>
                        {% else %}
                            <span class="badge badge-muted">{{ f["severity"] }}</span>
                        {% endif %}
                    </td>
                    <td class="cell-url" title="{{ f['url'] }}">{{ f["url"] }}</td>
                    <td>{{ f["parameter"] or "-" }}</td>
                    <td><code class="code-inline">{{ f["payload"] }}</code></td>
                    <td>{{ f["evidence"] }}</td>
                </tr>
            {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
        <p class="empty-text">
            ✅ No vulnerabilities detected with current tests.
        </p>
    {% endif %}
</section>

{% endblock %}
